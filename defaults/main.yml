---
# clickhouse cluster definition
clickhouse_version: "20.9.5.5"
clickhouse_allow_downgrade: false
clickhouse_cluster_name: "mycluster"
# replica list are all host of a group
clickhouse_replica_list: "{{ groups['clickhouse'] }}"
# shard list are calculated by replica list. The must accomplish with regex: see clickhouse_hostname_regex in vars/main.yml
clickhouse_shard_list: "{{ clickhouse_replica_list | map('extract', hostvars, 'ansible_hostname') | map('regex_search', clickhouse_hostname_regex, '\\1') | unique | map ('first') }}"

# user/group
clickhouse_group: clickhouse
clickhouse_user: clickhouse

# ch config
clickhouse_config:
  max_connections: 2048
  keep_alive_timeout: 3
  max_concurrent_queries: 100
  uncompressed_cache_size: 8589934592
  mark_cache_size: 5368709120
  builtin_dictionaries_reload_interval: 3600
  max_session_timeout: 3600
  default_session_timeout: 60
  mlock_status: false
  merge_tree_config: []

# yum support 
clickhouse_supported: yes
clickhouse_repo: "https://repo.clickhouse.tech/rpm/stable/x86_64/"
clickhouse_repo_key: https://repo.clickhouse.tech//CLICKHOUSE-KEY.GPG
clickhouse_package:
  - "clickhouse-client-{{ clickhouse_version }}"
  - "clickhouse-common-static-{{ clickhouse_version }}"
  - "clickhouse-server-{{ clickhouse_version }}"

# path
clickhouse_path_config: "/etc/clickhouse-server"
clickhouse_path_config_d: "{{ clickhouse_path_config }}/config.d"
clickhouse_path_log: "/var/log/clickhouse-server"
clickhouse_path_base: "/var/lib"
clickhouse_path_data: "{{ clickhouse_path_base }}/clickhouse/"
clickhouse_path_tmp: "{{ clickhouse_path_base }}/clickhouse/tmp/"
clickhouse_path_user_files: "{{ clickhouse_path_base }}/clickhouse/user_files/"

# ch networking
clickhouse_http_port: 8123
clickhouse_https_port: 8443
clickhouse_tcp_port: 9000
clickhouse_tcp_secure_port: 9440
clickhouse_interserver_http: 9009

clickhouse_listen_host_default:
  - "{{ clickhouse_replica_name }}"
  - "::1"

clickhouse_listen_host_custom: []
# see vars for clickhouse_listen_host_default
clickhouse_listen_host: "{{ clickhouse_listen_host_default + clickhouse_listen_host_custom }}"

# zookeeper is not at all mandatory. If zookeeper is not installed, replication must be accomplished by the client side
clickhouse_zookeeper_list: "{{ groups['zookeeper'] }}"
clickhouse_zookeeper_port: "2181"

# ch users: https://clickhouse.tech/docs/en/operations/configuration-files/
clickhouse_users_list:
  - { user_name: "reader",
      profile: "readonly",
      password: "r3ad3R",
      networks: ["::/0"],
      quota: "default",
      attribute: "replace" }
  - { user_name: "javito",
      profile: "default",
      password: "javito",
      networks: ["::/0"],
      quota: "default",
      attribute: "remove" }
  - { user_name: "default",
      profile: "default",
      networks: ["::/0"],
      quota: "default",
      attribute: "replace" }
  - { user_name: "luis",
      profile: "default",
      password: "luis",
      networks: ["::1", "127.0.0.1"],
      quota: "default",
      attribute: "remove" }

# ch logger
clickhouse_logger:
  level: trace
  log: "{{ clickhouse_path_log }}/clickhouse-server.log"
  errorlog: "{{ clickhouse_path_log }}/clickhouse-server.err.log"
  size: 1000M
  count: 10
